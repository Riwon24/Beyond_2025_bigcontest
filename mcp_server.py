import pandas as pd
from typing import List, Dict, Any, Optional
from langchain.schema import HumanMessage
from langchain_google_genai import ChatGoogleGenerativeAI
from dotenv import load_dotenv
import os

# FastMCP êµ¬ì¡° ì‚¬ìš©ì„ ìœ„í•œ ì„œë²„ ì„¤ì •
from fastmcp.server import FastMCP, Context

# FastMCP ì´ˆê¸°í™”
toolkit = FastMCP(
    "DatetectiveAnalysisServer",
    instructions="""
    ì‚¬ìš©ìžì˜ ë¬¸ì œ ìƒí™©ì„ ì‚¬ê±´ìœ¼ë¡œ ë³´ê³ , ê³ ê° ë°ì´í„°ë¥¼ ë‹¨ì„œë¡œ í™œìš©í•´ ì›ì¸ì„ ë¶„ì„í•œ í›„
    ê·¸ì— ë§žëŠ” ì „ëžµì„ ì œì‹œí•˜ëŠ” ë§ˆì¼€íŒ… íƒì • ë¶„ì„ ë„êµ¬ìž…ë‹ˆë‹¤.
    - ê°€ë§¹ì  íƒìƒ‰
    - í”„ë¡¬í”„íŠ¸ ìƒì„±
    - ì „ëžµ ë¶„ì„ í˜¸ì¶œ
    """
)

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ ë° Gemini ëª¨ë¸ ì´ˆê¸°í™”
load_dotenv()
GOOGLE_API_KEY = os.getenv("GOOGLE_API_KEY")
llm = ChatGoogleGenerativeAI(model="gemini-2.5-flash", google_api_key=GOOGLE_API_KEY, temperature=0.5)

# ì „ì²´ ë§¤ìž¥ ëª©ë¡ ì €ìž¥ìš© ë³€ìˆ˜
df_all: Optional[pd.DataFrame] = None

# ê°€ë§¹ì  ë°ì´í„° ë¡œë“œ
def load_store_data(store_name: str = ""):
    global df_all
    df = pd.read_csv("data/new_final_set_f_yearly1022.csv", encoding="cp949")
    df.columns = df.columns.str.lower()
    st_col = "mct_nm"

    df_all = df

    if not store_name:
        return None, df

    if st_col not in df.columns:
        raise ValueError(f"CSVì— '{st_col}' ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤.")

    store_row = df[df[st_col] == store_name]
    return store_row.iloc[0] if not store_row.empty else None, df


load_store_data()

# ê°€ë§¹ì ëª… ì°¾ê¸°
toolkit.tool()

def find_store_name(user_input: str) -> Optional[str]:
    global df_all
    if df_all is None:
        load_store_data()
    for name in df_all["mct_nm"].unique():
        if name in user_input:
            return name
    return None

# í”„ë¡¬í”„íŠ¸ ìƒì„± í•¨ìˆ˜
toolkit.tool()

def generate_prompt(messages: List[Dict[str, str]], store_row: Dict[str, Any],
                    column_descriptions: Dict[str, Any]) -> str:
    base = """
    ë‹¹ì‹ ì€ ìš°ë¦¬ ì£¼ë³€ ìŒì‹ ê°€ë§¹ì ì—ê²Œ ì§„ì§œ í•„ìš”í•œ â€˜ë§žì¶¤ ë§ˆì¼€íŒ… ì „ëžµâ€™ì„ ì œê³µí•˜ëŠ” **ë§ˆì¼€íŒ… ì „ë¬¸ íƒì •**, **ë°ì´í…í‹°ë¸Œ Datetective**ìž…ë‹ˆë‹¤. 
    ì‚¬ëžŒë“¤ì€ ë‹¹ì‹ ì„ **íƒì • D**ë¼ê³  ë¶€ë¦…ë‹ˆë‹¤.

    ì‚¬ìš©ìžì˜ ë¬¸ì œ ìƒí™©ì„ **ì‚¬ê±´**ìœ¼ë¡œ ë³´ê³ , ê³ ê° ë°ì´í„°ë¥¼ **ë‹¨ì„œ**ë¡œ í™œìš©í•´ ì›ì¸ì„ ë¶„ì„í•œ ë’¤,
    ê·¸ì— ë§žëŠ” ì „ëžµì„ **ìˆ˜ì‚¬ ë³´ê³ ì„œ**ì²˜ëŸ¼ ì •ë¦¬í•´ ì œì‹œí•˜ì„¸ìš”.

    - ì‚¬ìš©ìžê°€ ê²ªê³  ìžˆëŠ” ë¬¸ì œ = ì‚¬ê±´  
    - ê³ ê° ë°ì´í„° = ë‹¨ì„œ  
    - ë¶„ì„ ê²°ê³¼ = ìˆ˜ì‚¬ ë³´ê³ ì„œ  
    - ì „ëžµ ì œì‹œ = ë²”ì¸(ì›ì¸) ê²€ê±° + í•´ê²° ë°©ì•ˆ ì œì‹œ  
    - ì „ëžµ íš¨ê³¼ = ì‚¬ê±´ ì´í›„ ë³€í™” ì˜ˆì¸¡ ë³´ê³   

    ---

    ## ðŸ“ ì¶œë ¥ í˜•ì‹ ì˜ˆì‹œ (ì•„ëž˜ êµ¬ì„±ê³¼ ìœ ì‚¬í•˜ê²Œ ìž‘ì„±í•´ ì£¼ì„¸ìš”)

    ### ðŸš¨ ì‚¬ê±´ëª…
    - ì‚¬ìš©ìžì˜ ë¬¸ì œ ìƒí™©ì„ í•µì‹¬ í‚¤ì›Œë“œë¡œ ìš”ì•½í•œ **ì‚¬ê±´ ì œëª©**ì„ í•œ ì¤„ë¡œ ìž‘ì„±í•´ ì£¼ì„¸ìš”.
    - ê°€ê²Œëª…ì„ í¬í•¨í•˜ì—¬ ë¶„ì„ì„ ìœ„í•œ ê´€ì°° ì œëª©ì²˜ëŸ¼ ìž‘ì„±í•´ ì£¼ì„¸ìš”.  
        - ì˜ˆ: ã…‡ã…‡ë§¤ìž¥ ë‹¨ê³¨ ì†ë‹˜ ê°ì†Œ ì¶”ì • ê±´, ã…ã…ë§¤ìž¥ ì‹ ê·œ ìœ ìž…ë¥  ì €í•˜ ì˜ì‹¬ ë“±

    ---

    ### ðŸ“‹ ì‚¬ê±´ ê°œìš”
    - ì‚¬ìš©ìžê°€ ìž…ë ¥í•œ ë¬¸ì œ ìƒí™©ì˜ **ë°°ê²½ê³¼ ë§¥ë½**ì„ ëª…í™•í•˜ê²Œ ì„¤ëª…í•´ ì£¼ì„¸ìš”.
    - ì§€ë‚˜ì¹˜ê²Œ ê°ì •ì ì´ê¸°ë³´ë‹¨, **íƒì •ì´ í˜„ìž¥ì„ ê¸°ë¡í•˜ë“¯** ì •ë¦¬í•´ ì£¼ì„¸ìš”.
    - ë¬¸ì œì˜ ì§•í›„, ë§¥ë½, ê´€ì°°ëœ íŒ¨í„´ ë“±ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì„œìˆ í•©ë‹ˆë‹¤.

    ---

    ### ðŸ§© ë‹¨ì„œ ë¶„ì„

    | ì£¼ìš” ì§€í‘œ | ê°’ ë˜ëŠ” ìƒíƒœ | í•´ì„ |
    |-----------|--------------|------|
    | ì˜ˆ: ìž¬ë°©ë¬¸ ê³ ê° ë¹„ì¤‘ | 25% | ì—…ì¢… í‰ê· ë³´ë‹¤ ë‚®ìŒ. ê³ ê° ì¶©ì„±ë„ ë¶€ì¡± |
    | ì˜ˆ: ë°°ë‹¬ ë§¤ì¶œ ë¹„ìœ¨ | 10% | ë°°ë‹¬ ì±„ë„ í™œìš©ë„ ë‚®ìŒ |

    - ê°€ëŠ¥í•œ ê²½ìš° **store_row ë°ì´í„°ë¥¼ ê¸°ë°˜**ìœ¼ë¡œ, ì—†ëŠ” ê²½ìš° **ìœ ì‚¬ ì—…ì¢… í‰ê· ì„ ê°€ì •í•˜ì—¬ ìž‘ì„±**í•˜ì„¸ìš”.
    - ì‚¬ìš©ìžì˜ ë°œí™”ì™€ ê°€ë§¹ì  ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ íƒì§€ëœ ì£¼ìš” ì§€í‘œ/ìˆ˜ì¹˜/íŒ¨í„´ì„ ì •ë¦¬í•´ ì£¼ì„¸ìš”.

    ---

    ### ðŸ“Š ë‹¨ì„œ ì‹œê°í™”
    [[VISUALIZATION_PLACEHOLDER]]

    ---

    ### ðŸ§­ ì›ì¸ ì¶”ë¡ 
    - ë‹¨ì„œ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ **ì‹¤ì œ ì›ì¸ì„ ëª…í™•ížˆ ì¶”ë¡ **í•´ ì£¼ì„¸ìš”.
    - ë§ˆì¹˜ íƒì •ì²˜ëŸ¼ â€œì´ ì‚¬ê±´ì˜ í•µì‹¬ ì›ì¸ì€ â—‹â—‹ìž…ë‹ˆë‹¤â€ í˜•ì‹ìœ¼ë¡œ ìž‘ì„±í•´ ì£¼ì„¸ìš”.

    ---

    ### ðŸ’¡ í•´ê²° ì „ëžµ ì œì‹œ

    #### 1. ì „ëžµ ì œëª© (ì´ëª¨ì§€ í¬í•¨)  
    - íƒ€ê¹ƒ ê³ ê°:  
    - ì£¼ìš” ì±„ë„:  
    - ì‹¤í–‰ ë°©ì•ˆ:  

    #### 2. ... (ê°™ì€ í˜•ì‹ìœ¼ë¡œ ì´ 3ê°œ ì „ëžµ ì œì‹œ)

    ---

    ### ðŸª„ ê¸°ëŒ€ íš¨ê³¼

    - ì œëª©ì—ëŠ” ë°˜ë“œì‹œ **ì´ëª¨ì§€ í•˜ë‚˜**ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.
    - ì•žì„œ ë‚˜ì˜¨ í•´ê²° ì „ëžµì„ ì ìš©í•  ê²½ìš° í•´ë‹¹ ë§¤ìž¥ì´ ì–»ì„ ìˆ˜ ìžˆëŠ” ê¸°ëŒ€ íš¨ê³¼ë¥¼ ì ì–´ì£¼ì„¸ìš”.   
    - **ìˆ˜ì¹˜ ê¸°ë°˜ íš¨ê³¼**(ì˜ˆ: +12%, 100ëª… ì´ìƒ ìœ ìž… ë“±)ë¥¼ í¬í•¨í•´ ì£¼ì„¸ìš”.  
    - ì „ëžµ íš¨ê³¼ë¥¼ ì„¤ëª…í•  ë•ŒëŠ” ì‹ ë¢°í•  ìˆ˜ ìžˆëŠ” êµ¬ì²´ì ì¸ ê·¼ê±°(ì˜ˆ: ì •ë¶€ ê¸°ê´€ í†µê³„, ê³µê³µ ë°ì´í„°, ì—°êµ¬ ê²°ê³¼ ë“±)ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•´ì£¼ì„¸ìš”.  
       (ì˜ˆ: â€œ2025 í†µê³„ì²­ ì†Œë¹„ íŠ¸ë Œë“œ ì¡°ì‚¬ì— ë”°ë¥´ë©´ 20ëŒ€ ì—¬ì„±ì˜ ì™¸ì‹ ë¹ˆë„ëŠ” ì „ë…„ ëŒ€ë¹„ 12% ì¦ê°€í–ˆìŠµë‹ˆë‹¤.â€)  
    - ê° í•­ëª©ì€ **ë²ˆí˜¸, ì´ëª¨ì§€, ì œëª©, ê·¼ê±°, ì„¤ëª…** êµ¬ì¡°ë¡œ ìž‘ì„±í•´ ì£¼ì„¸ìš”.

    ì¶œë ¥ ì˜ˆì‹œ:

    #### 1. ðŸ’¡ ì‹ ê·œ ê³ ê° ìœ ìž… ì¦ê°€  
    - ê·¼ê±°: 2025 í†µê³„ì²­ ì†Œë¹„ íŠ¸ë Œë“œ ì¡°ì‚¬ì— ë”°ë¥´ë©´ 20ëŒ€ ì—¬ì„±ì˜ ì™¸ì‹ ë¹ˆë„ëŠ” ì „ë…„ ëŒ€ë¹„ 12% ì¦ê°€í–ˆìŠµë‹ˆë‹¤.  
    - ì„¤ëª…: SNS ì´ë²¤íŠ¸ ë° ë¦¬ë·° ì¸ì¦ ìº íŽ˜ì¸ì„ í†µí•´ ì‹ ê·œ ê³ ê° ìœ ìž…ë¥ ì´ ì•½ +15% ì¦ê°€í•  ê²ƒìœ¼ë¡œ ì˜ˆìƒë©ë‹ˆë‹¤.  

    ---
    """

    # ì»¬ëŸ¼ ì„¤ëª… í¬í•¨
    base += "\n\nðŸ“Œ ì°¸ê³ : ë°ì´í„° ì»¬ëŸ¼ ì„¤ëª…\n"
    for col, (name, desc) in column_descriptions.items():
        base += f"- {col} ({name}): {desc}\n"

    # ê°€ë§¹ì  ë°ì´í„°
    if store_row is not None:
        base += "\n\nðŸ“‚ ê°€ë§¹ì  ë°ì´í„° ìš”ì•½:\n"
        for col, val in store_row.items():
            base += f"- {col}: {val}\n"
    else:
        base += "\n\nðŸ“‚ ê°€ë§¹ì  ë°ì´í„°ëŠ” ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì‚¬ìš©ìž ë©”ì‹œì§€ë§Œ ì°¸ê³ í•´ ì£¼ì„¸ìš”.\n"

    # ëŒ€í™” ë‚´ìš©
    for msg in messages:
        base += f"\nì‚¬ìš©ìž: {msg['content']}"

    base += "\níƒì •ìœ¼ë¡œì„œ ë¶„ì„ì„ ì‹œìž‘í•˜ì„¸ìš”."
    return base


# ì‹œê°í™” ì‚½ìž… ì—¬ë¶€ í™•ì¸
toolkit.tool()

def has_visualization(content: str) -> bool:
    return "[[VISUALIZATION_PLACEHOLDER]]" in content

# Gemini í˜¸ì¶œ ë¶„ì„ í•¨ìˆ˜
toolkit.tool()

def analyze_case(messages: List[Dict[str, str]], store_row: Dict[str, Any], column_descriptions: Dict[str, Any]) -> str:
    prompt = generate_prompt(messages, store_row, column_descriptions)
    response = llm.invoke([HumanMessage(content=prompt)])
    return response.content

# FastMCP ì„œë²„ ì‹¤í–‰
def run_server():
    toolkit.run()

if __name__ == "__main__":
    run_server()
